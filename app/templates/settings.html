{% extends 'base.html' %}
{% block content %}
<!-- Success Popup -->
<div id="success-popup" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 10000; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 600; font-size: 1rem; max-width: 300px;">
  <div style="display: flex; align-items: center; gap: 0.5rem;">
    <span style="font-size: 1.2rem;">‚úì</span>
    <span id="success-message">Settings saved successfully!</span>
  </div>
</div>

<div class="settings-container" style="max-width: 600px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(79,140,255,0.10), 0 1.5px 8px rgba(0,0,0,0.04); padding: 2.5rem 2rem 2rem 2rem;">
  <h1 style="color: #4f8cff; font-size: 2rem; font-weight: 700; margin-bottom: 2rem; letter-spacing: 1px; text-align: left;">Settings</h1>
  
  <!-- Pagination Settings (visible to all users) -->
  <div style="margin-bottom: 3rem; padding: 1.5rem; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
    <h2 style="color: #2d3a4b; font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem;">Pagination Settings</h2>
    <form method="post" action="{{ url_for('main.update_pagination_settings') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div style="margin-bottom: 1.5rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; color: #374151; cursor: pointer;">
          <input type="checkbox" name="pagination_enabled" {% if user_settings.pagination_enabled %}checked{% endif %} 
                 style="width: 1.2rem; height: 1.2rem; border-radius: 4px; border: 2px solid #d1d5db; accent-color: #4f8cff;">
          Enable pagination for tickets page
        </label>
      </div>
      <div style="margin-bottom: 1.5rem;" id="tickets-per-page-container">
        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Tickets per page:</label>
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
          <select name="tickets_per_page_preset" id="tickets-per-page-preset" style="padding: 0.5rem 0.8rem; border-radius: 6px; border: 1px solid #d1d5db; font-size: 1rem; background: #fff; color: #2d3a4b; min-width: 120px;">
            <option value="">Custom</option>
            <option value="5" {% if user_settings.tickets_per_page == 5 %}selected{% endif %}>5</option>
            <option value="10" {% if user_settings.tickets_per_page == 10 %}selected{% endif %}>10</option>
            <option value="20" {% if user_settings.tickets_per_page == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if user_settings.tickets_per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if user_settings.tickets_per_page == 100 %}selected{% endif %}>100</option>
          </select>
          <span style="color: #6b7280; font-weight: 500;">or</span>
          <input type="number" name="tickets_per_page" id="custom-tickets-per-page" 
                 value="{{ user_settings.tickets_per_page }}" 
                 min="1" max="500" placeholder="Enter custom value"
                 style="padding: 0.5rem 0.8rem; border-radius: 6px; border: 1px solid #d1d5db; font-size: 1rem; background: #fff; color: #2d3a4b; width: 160px;">
        </div>
        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
          Choose a preset value or enter a custom number (1-500)
        </div>
      </div>
      <button type="submit" style="background: #4f8cff; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.5rem; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background 0.2s; box-shadow: 0 1px 4px rgba(79,140,255,0.08);">
        Save Settings
      </button>
    </form>
  </div>

  <!-- Category Management (admin only) -->
  {% if current_user.role == 'admin' %}
  <div style="padding: 1.5rem; background: #fef7ff; border-radius: 12px; border: 1px solid #e9d5ff; margin-bottom: 3rem;">
    <h2 style="color: #7c3aed; font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem;">Manage Categories</h2>
    <form method="post" action="{{ url_for('main.add_category') }}" style="margin-bottom:2rem; display:flex; gap:1rem; align-items:center;">
      <input type="text" name="category" placeholder="New Category" required style="flex:1; padding:0.5rem 0.8rem; border-radius:6px; border:1px solid #d1d5db; font-size:1rem;">
      <button type="submit" style="background:#2563eb; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; font-weight:700; font-size:1.08rem; box-shadow:0 1px 4px rgba(37,99,235,0.08); cursor:pointer; transition:background 0.2s;">Add</button>
    </form>
    <table style="width:100%; border-collapse:separate; border-spacing:0 0.5rem;">
      <thead>
        <tr><th style="text-align:left; background:#f4f6fb; color:#4f8cff; font-weight:600; padding:0.7rem 1rem; border-radius:8px 0 0 8px;">Category</th><th style="background:#f4f6fb; color:#4f8cff; font-weight:600; padding:0.7rem 1rem; border-radius:0 8px 8px 0;">Actions</th></tr>
      </thead>
      <tbody>
        {% for cat in all_categories %}
        <tr class="category-row">
          <td style="padding:0.7rem 1rem; background:#f9fafb; border-radius:8px 0 0 8px; font-size:1.08rem; color:#2d3a4b;">
            <span class="category-name">{{ cat.name }}</span>
            <input type="text" class="edit-category-field" value="{{ cat.name }}" style="display:none; padding:0.3rem 0.7rem; border-radius:6px; border:1px solid #d1d5db; font-size:1rem; margin-left:0.5rem;">
          </td>
          <td style="padding:0.7rem 1rem; background:#f9fafb; border-radius:0 8px 8px 0;">
            <!-- Edit button removed as requested -->
            <form method="post" action="{{ url_for('main.delete_category', category=cat.name) }}" style="display:inline-block;">
              <button type="submit" style="background:#dc2626; color:#fff; border:none; border-radius:6px; padding:0.3rem 0.9rem; font-weight:700; font-size:1rem; cursor:pointer;">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Knowledge Base Management (admin only) -->
  <div style="padding: 1.5rem; background: #f0fdf4; border-radius: 12px; border: 1px solid #bbf7d0;">
    <h2 style="color: #15803d; font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem;">üìö Knowledge Base Management</h2>
    
    <!-- Knowledge Base Status -->
    <div id="kb-status" style="background: #ffffff; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #d1d5db;">
      <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
        <span style="font-weight: 600; color: #374151;">Knowledge Base Status:</span>
        <button onclick="checkKnowledgeBaseStatus()" style="background: #6b7280; color: #fff; border: none; border-radius: 4px; padding: 0.3rem 0.8rem; font-size: 0.85rem; cursor: pointer;">Refresh</button>
      </div>
      <div id="kb-status-content" style="color: #6b7280; font-style: italic;">Click refresh to check status...</div>
      <div id="kb-source-path" style="margin-top: 0.5rem; font-size: 0.85rem; color: #4b5563; font-family: monospace; background: #f9fafb; padding: 0.5rem; border-radius: 4px; border: 1px solid #e5e7eb;"></div>
    </div>

    <!-- Knowledge Base Editor -->
    <form method="post" action="{{ url_for('main.update_knowledge_base') }}" id="kb-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Knowledge Base Content:</label>
        <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem;">
          This content will be used by the AI chatbot to answer user questions. Include procedures, troubleshooting steps, and guidelines.
        </div>
        <textarea 
          name="knowledge_base_content" 
          id="knowledge-base-textarea"
          placeholder="Loading knowledge base content..."
          style="width: 93%; min-height: 300px; padding: 1rem; border-radius: 8px; border: 1px solid #d1d5db; font-size: 0.9rem; font-family: 'Courier New', monospace; background: #f9fafb; color: #2d3a4b; resize: vertical;"
        ></textarea>
      </div>

      <div style="display: flex; gap: 1rem; align-items: center;">
        <button type="submit" style="background: #15803d; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.5rem; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background 0.2s; box-shadow: 0 1px 4px rgba(21,128,61,0.08);">
          üíæ Save Knowledge Base
        </button>
        
        <button type="button" onclick="resetKnowledgeBase()" style="background: #dc2626; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.5rem; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background 0.2s;">
          üîÑ Reset to Default
        </button>
      </div>
    </form>
  </div>

  <!-- OpenAI API Key Management (admin only) -->
  <div style="padding: 1.5rem; background: #fef3c7; border-radius: 12px; border: 1px solid #fbbf24; margin-top: 2rem;">
    <h2 style="color: #92400e; font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem;">üîë OpenAI API Key Management</h2>
    
    <!-- Current API Key Status -->
    <div style="background: #ffffff; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #d1d5db;">
      <div style="margin-bottom: 1rem;">
        <span style="font-weight: 600; color: #374151;">Current API Key Source:</span>
        <span style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: 500; 
              {% if system_settings.using_env_key %}background: #dcfce7; color: #166534;{% else %}background: #dbeafe; color: #1e40af;{% endif %}">
          {% if system_settings.using_env_key %}Environment Variable{% else %}Custom API Key{% endif %}
        </span>
      </div>
      
      <!-- Current API Key Display (always show) -->
      <div style="margin-bottom: 1rem;">
        <span style="font-weight: 600; color: #374151;">Current API Key:</span>
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
          <input type="text" id="current-api-key" readonly 
                 data-full-key="{% if system_settings.using_env_key %}{{ system_settings.env_api_key }}{% else %}{{ system_settings.openai_api_key }}{% endif %}"
                 value="{% if system_settings.using_env_key %}{{ system_settings.env_api_key }}{% else %}{{ system_settings.openai_api_key }}{% endif %}"
                 style="font-family: monospace; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; padding: 0.5rem; width: 350px; color: #4b5563;">
          <button type="button" onclick="toggleApiKeyVisibility()" style="background: #6b7280; color: #fff; border: none; border-radius: 4px; padding: 0.5rem; cursor: pointer; display: flex; align-items: center;">
            <span id="eye-icon">üëÅÔ∏è</span>
          </button>
        </div>
        <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
          Source: {% if system_settings.using_env_key %}Environment Variable (.env){% else %}Custom API Key{% endif %}
        </div>
      </div>
    </div>

    <!-- API Key Configuration Form -->
    <form method="post" action="{{ url_for('main.update_openai_api_key') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      
      <div style="margin-bottom: 1.5rem;">
        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; color: #374151; cursor: pointer; margin-bottom: 1rem;">
          <input type="checkbox" name="use_env_key" {% if system_settings.using_env_key %}checked{% endif %} 
                 onchange="toggleApiKeyInput(this)"
                 style="width: 1.2rem; height: 1.2rem; border-radius: 4px; border: 2px solid #d1d5db; accent-color: #f59e0b;">
          Use Environment Variable (.env file)
        </label>
        
        <div id="custom-api-key-section" style="{% if system_settings.using_env_key %}display: none;{% endif %}">
          <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Custom OpenAI API Key:</label>
          <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem;">
            Enter your OpenAI API key. This will override the environment variable setting.
          </div>
          <input type="text" name="openai_api_key" id="new-api-key"
                 placeholder="sk-..."
                 style="width: 93%; padding: 0.75rem; border-radius: 6px; border: 1px solid #d1d5db; font-size: 1rem; font-family: monospace; background: #fff; color: #2d3a4b;">
          <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #6b7280;">
            üí° API keys typically start with "sk-" and are 51 characters long
          </div>
        </div>
      </div>

      <button type="submit" style="background: #f59e0b; color: #fff; border: none; border-radius: 6px; padding: 0.6rem 1.5rem; font-weight: 700; font-size: 1rem; cursor: pointer; transition: background 0.2s; box-shadow: 0 1px 4px rgba(245,158,11,0.08);">
        üîë Update API Key
      </button>
    </form>
  </div>
  {% endif %}
</div>

<script>
// Success popup functionality
function showSuccessPopup(message) {
  const popup = document.getElementById('success-popup');
  const messageElement = document.getElementById('success-message');
  
  messageElement.textContent = message;
  popup.style.display = 'block';
  
  // Auto-hide after 3 seconds
  setTimeout(() => {
    popup.style.display = 'none';
  }, 3000);
}

// Show popup if there are flash messages
document.addEventListener('DOMContentLoaded', function() {
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
        showSuccessPopup('{{ message }}');
      {% endfor %}
    {% endif %}
  {% endwith %}
});

// Show/hide tickets per page setting based on pagination checkbox
document.addEventListener('DOMContentLoaded', function() {
  const paginationCheckbox = document.querySelector('input[name="pagination_enabled"]');
  const ticketsPerPageContainer = document.getElementById('tickets-per-page-container');
  const presetSelect = document.getElementById('tickets-per-page-preset');
  const customInput = document.getElementById('custom-tickets-per-page');
  
  function toggleTicketsPerPage() {
    if (paginationCheckbox.checked) {
      ticketsPerPageContainer.style.display = 'block';
    } else {
      ticketsPerPageContainer.style.display = 'none';
    }
  }
  
  // Set initial state
  toggleTicketsPerPage();
  
  // Check if current value matches any preset
  function updatePresetSelection() {
    const currentValue = customInput.value;
    const presetOptions = presetSelect.querySelectorAll('option[value]:not([value=""])');
    let foundMatch = false;
    
    presetOptions.forEach(option => {
      if (option.value === currentValue) {
        presetSelect.value = currentValue;
        foundMatch = true;
      }
    });
    
    if (!foundMatch) {
      presetSelect.value = '';
    }
  }
  
  // Initialize preset selection
  updatePresetSelection();
  
  // Handle preset selection
  presetSelect.addEventListener('change', function() {
    if (this.value !== '') {
      customInput.value = this.value;
    }
  });
  
  // Handle custom input changes
  customInput.addEventListener('input', function() {
    // Validate input
    let value = parseInt(this.value);
    if (isNaN(value) || value < 1) {
      value = 1;
      this.value = value;
    } else if (value > 500) {
      value = 500;
      this.value = value;
    }
    
    // Update preset selection
    updatePresetSelection();
  });
  
  // Listen for pagination checkbox changes
  paginationCheckbox.addEventListener('change', toggleTicketsPerPage);
});

// Knowledge Base Management Functions
function checkKnowledgeBaseStatus() {
  const statusContent = document.getElementById('kb-status-content');
  const sourcePathDiv = document.getElementById('kb-source-path');
  
  statusContent.innerHTML = '<span style="color: #6b7280;">üîÑ Checking status...</span>';
  sourcePathDiv.innerHTML = '';
  
  fetch('/api/ai/get-knowledge-status')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const status = data.status;
        statusContent.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div><strong>Status:</strong> ${status.loaded ? '‚úÖ Loaded' : '‚ùå Failed'}</div>
            <div><strong>Content:</strong> ${status.content_length} characters</div>
            <div><strong>Type:</strong> ${getSourceTypeDisplay(status.source_type)}</div>
          </div>
          <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
            <strong>Preview:</strong> ${status.preview}
          </div>
        `;
        
        // Show the source path
        sourcePathDiv.innerHTML = `<strong>Source:</strong> ${status.source_path}`;
        
        // Load the current knowledge base content into the textarea
        loadKnowledgeBaseContent();
      } else {
        statusContent.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${data.error}</span>`;
        sourcePathDiv.innerHTML = '';
      }
    })
    .catch(error => {
      statusContent.innerHTML = `<span style="color: #dc2626;">‚ùå Failed to check status: ${error}</span>`;
      sourcePathDiv.innerHTML = '';
    });
}

function getSourceTypeDisplay(sourceType) {
  const typeMap = {
    'edited_text_copy': '‚úèÔ∏è Edited Copy',
    'edited_document_copy': '‚úèÔ∏è Edited Document',
    'custom_text': 'üìù Custom Text',
    'original_document': 'üìÑ Original Document',
    'fallback_content': '‚ö†Ô∏è Fallback Content'
  };
  return typeMap[sourceType] || '‚ùì Unknown';
}

function loadKnowledgeBaseContent() {
  const textarea = document.getElementById('knowledge-base-textarea');
  textarea.placeholder = 'Loading current knowledge base...';
  
  fetch('/api/ai/get-knowledge-content')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        textarea.value = data.content;
        textarea.placeholder = 'Enter knowledge base content...';
      } else {
        textarea.placeholder = 'Failed to load content. You can enter new content here.';
      }
    })
    .catch(error => {
      textarea.placeholder = 'Error loading content. You can enter new content here.';
    });
}

function resetKnowledgeBase() {
  if (confirm('‚ö†Ô∏è Are you sure you want to reset the knowledge base to default content? This will overwrite any custom changes.')) {
    fetch('/api/ai/reset-knowledge-base', { method: 'POST' })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.text(); // Get as text first to debug
      })
      .then(text => {
        try {
          const data = JSON.parse(text);
          if (data.success) {
            showSuccessPopup('Knowledge base reset to default content');
            loadKnowledgeBaseContent();
            checkKnowledgeBaseStatus();
          } else {
            alert('‚ùå Failed to reset: ' + (data.error || 'Unknown error'));
          }
        } catch (e) {
          console.error('Response was not JSON:', text);
          alert('‚ùå Reset failed - unexpected response: ' + text.substring(0, 100));
        }
      })
      .catch(error => {
        console.error('Reset error:', error);
        alert('‚ùå Reset failed: ' + error);
      });
  }
}

// API Key Management Functions
function toggleApiKeyVisibility() {
  const keyInput = document.getElementById('current-api-key');
  const eyeIcon = document.getElementById('eye-icon');
  const fullKey = keyInput.getAttribute('data-full-key');
  
  console.log('Toggle API Key - Full Key:', fullKey ? fullKey.substring(0, 8) + '...' : 'None');
  console.log('Toggle API Key - Current Value:', keyInput.value);
  
  if (!fullKey) {
    console.log('No full key found');
    return; // No key to show
  }
  
  // Check if currently showing full key by comparing values
  const isShowingFull = keyInput.value === fullKey;
  console.log('Is showing full key:', isShowingFull);
  
  if (!isShowingFull) {
    // Currently masked, show full key
    keyInput.value = fullKey;
    eyeIcon.textContent = 'üôà';
    keyInput.setAttribute('data-showing-full', 'true');
    console.log('Switched to showing full key');
  } else {
    // Currently showing full key, mask it
    if (fullKey.length > 12) {
      const masked = fullKey.substring(0, 8) + '***********' + fullKey.substring(fullKey.length - 4);
      keyInput.value = masked;
    } else {
      keyInput.value = '*'.repeat(fullKey.length);
    }
    eyeIcon.textContent = 'üëÅÔ∏è';
    keyInput.setAttribute('data-showing-full', 'false');
    console.log('Switched to showing masked key');
  }
}

function toggleApiKeyInput(checkbox) {
  const customSection = document.getElementById('custom-api-key-section');
  const newApiKeyInput = document.getElementById('new-api-key');
  
  if (checkbox.checked) {
    customSection.style.display = 'none';
    newApiKeyInput.required = false;
  } else {
    customSection.style.display = 'block';
    newApiKeyInput.required = true;
  }
}

// Auto-load knowledge base status when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Existing pagination code...
  
  // Check if we're on settings page and user is admin
  if (document.getElementById('kb-status')) {
    checkKnowledgeBaseStatus();
  }
  
  // Set up API key display
  const currentKeyInput = document.getElementById('current-api-key');
  if (currentKeyInput && currentKeyInput.value) {
    const fullKey = currentKeyInput.getAttribute('data-full-key');
    if (fullKey && fullKey.length > 12) {
      // Initialize with masked view
      const masked = fullKey.substring(0, 8) + '***********' + fullKey.substring(fullKey.length - 4);
      currentKeyInput.value = masked;
      currentKeyInput.setAttribute('data-showing-full', 'false');
    } else if (fullKey) {
      // For shorter keys, mask completely
      currentKeyInput.value = '*'.repeat(fullKey.length);
      currentKeyInput.setAttribute('data-showing-full', 'false');
    }
  }
});
</script>
{% endblock %}
