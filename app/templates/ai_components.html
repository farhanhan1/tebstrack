<!-- AI Recommendation Section - Add this to viewticket.html after the ticket details table -->

<div id="ai-recommendations" style="max-width: 700px; margin: 20px auto; padding: 1.5rem 2rem; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px rgba(79,140,255,0.10), 0 1.5px 8px rgba(0,0,0,0.04);">
  <h3 style="color: #4f8cff; font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;">
      <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    AI Recommendations
  </h3>
  
  <!-- AI Categorization Results -->
  <div id="ai-categorization" style="margin-bottom: 1.5rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border-left: 4px solid #4f8cff;">
    <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 1rem;">Categorization Analysis</h4>
    <div id="categorization-content">
      <button onclick="getAICategorization()" style="background: #4f8cff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
        Analyze with AI
      </button>
    </div>
  </div>
  
  <!-- Email Template Recommendation -->
  <div id="ai-template" style="margin-bottom: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #059669;">
    <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 1rem;">Email Template Recommendation</h4>
    <div id="template-content">
      <button onclick="getTemplateRecommendation()" style="background: #059669; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
        Get Template Suggestion
      </button>
    </div>
  </div>
  
  <!-- Template Selection -->
  <div id="template-selection" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #fefce8; border-radius: 8px; border-left: 4px solid #ca8a04;">
    <h4 style="margin: 0 0 0.5rem 0; color: #374151; font-size: 1rem;">Select Email Template</h4>
    <select id="template-selector" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 0.5rem;">
      <option value="">Choose a template...</option>
    </select>
    <button onclick="useSelectedTemplate()" style="background: #ca8a04; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
      Use Selected Template
    </button>
  </div>
</div>

<script>
// AI Categorization Function
function getAICategorization() {
  const subject = document.querySelector('input[name="subject"]').value;
  const body = "{{ ticket.body|e|replace('\n', '\\n')|replace('\r', '')|replace('\"', '\\\"') }}";
  const sender = "{{ ticket.sender|e }}";
  
  const contentDiv = document.getElementById('categorization-content');
  contentDiv.innerHTML = '<div style="color: #6b7280; font-style: italic;">Analyzing...</div>';
  
  fetch('/api/ai/categorize', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      subject: subject,
      body: body,
      sender: sender
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const result = data.categorization;
      contentDiv.innerHTML = `
        <div style="margin-bottom: 0.5rem;">
          <strong>Suggested Category:</strong> 
          <span style="background: #e0e7ff; color: #4f8cff; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600;">${result.category}</span>
        </div>
        <div style="margin-bottom: 0.5rem;">
          <strong>Suggested Urgency:</strong> 
          <span style="background: ${getUrgencyColor(result.urgency)}; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600;">${result.urgency}</span>
        </div>
        <div style="margin-bottom: 0.5rem;">
          <strong>Confidence:</strong> ${Math.round(result.confidence * 100)}%
        </div>
        <div style="margin-bottom: 1rem; color: #6b7280; font-size: 0.9rem;">
          ${result.reasoning}
        </div>
        <button onclick="applyCategorization('${result.category}', '${result.urgency}')" 
                style="background: #059669; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; margin-right: 0.5rem;">
          Apply Suggestions
        </button>
        <button onclick="getAICategorization()" 
                style="background: #6b7280; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
          Re-analyze
        </button>
      `;
    } else {
      contentDiv.innerHTML = '<div style="color: #dc2626;">Error: ' + (data.error || 'Analysis failed') + '</div>';
    }
  })
  .catch(error => {
    console.error('AI categorization error:', error);
    contentDiv.innerHTML = '<div style="color: #dc2626;">Error connecting to AI service.</div>';
  });
}

// Template Recommendation Function
function getTemplateRecommendation() {
  const subject = document.querySelector('input[name="subject"]').value;
  const body = "{{ ticket.body|e|replace('\n', '\\n')|replace('\r', '')|replace('\"', '\\\"') }}";
  const category = document.querySelector('select[name="category"]').value;
  
  const contentDiv = document.getElementById('template-content');
  contentDiv.innerHTML = '<div style="color: #6b7280; font-style: italic;">Getting recommendation...</div>';
  
  fetch('/api/ai/recommend-template', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      subject: subject,
      body: body,
      category: category
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.templates) {
      const result = data.templates;
      let html = '';
      
      if (result.recommended_template) {
        const confidence = Math.round((result.confidence || result.template_match_score || 0) * 100);
        
        html = `
          <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #059669;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
              <h5 style="margin: 0; color: #059669; font-size: 1.1rem;">
                <i class="fas fa-robot" style="margin-right: 0.5rem;"></i>AI Recommendation
              </h5>
              <span style="background: #059669; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                ${confidence}% Confidence
              </span>
            </div>
            
            <div style="background: white; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.75rem;">
              <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                Recommended Template: <span style="color: #059669;">${result.recommended_template}</span>
              </div>
              <div style="color: #6b7280; font-size: 0.9rem; line-height: 1.4;">
                ${result.reasoning}
              </div>
            </div>
            
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button onclick="useRecommendedTemplate('${escapeJs(result.recommended_template)}')" 
                      style="background: #059669; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-check" style="margin-right: 0.3rem;"></i>Use This Template
              </button>
              <button onclick="showTemplateSelection()" 
                      style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                <i class="fas fa-list" style="margin-right: 0.3rem;"></i>Choose Different
              </button>
              <button onclick="getTemplateRecommendation()" 
                      style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                <i class="fas fa-refresh" style="margin-right: 0.3rem;"></i>Re-analyze
              </button>
            </div>
        `;
        
        // Show alternative templates if available
        if (result.alternative_templates && result.alternative_templates.length > 0) {
          html += `
            <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f8fafc; border-radius: 6px;">
              <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 0.5rem;">
                <strong>Other Options:</strong>
              </div>
              <div style="display: flex; gap: 0.4rem; flex-wrap: wrap;">
          `;
          
          result.alternative_templates.forEach(template => {
            html += `
              <button onclick="useRecommendedTemplate('${escapeJs(template)}')" 
                      style="background: #e5e7eb; color: #374151; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: background 0.2s;">
                ${template}
              </button>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
        
        html += '</div>';
      } else {
        // No recommendation found
        html = `
          <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #f59e0b;">
            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
              <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-right: 0.5rem;"></i>
              <h5 style="margin: 0; color: #92400e;">No Specific Template Recommended</h5>
            </div>
            <div style="color: #6b7280; font-size: 0.9rem; margin-bottom: 0.75rem;">
              ${result.reasoning || 'The AI could not find a specific template that matches this ticket well.'}
            </div>
            <button onclick="showTemplateSelection()" 
                    style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
              <i class="fas fa-list" style="margin-right: 0.3rem;"></i>Browse All Templates
            </button>
          </div>
        `;
      }
      
      contentDiv.innerHTML = html;
    } else {
      contentDiv.innerHTML = `
        <div style="color: #dc2626; background: #fee2e2; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #dc2626;">
          <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
          Error: ${data.error || 'Template recommendation failed'}
        </div>
      `;
    }
  })
  .catch(error => {
    console.error('Template recommendation error:', error);
    contentDiv.innerHTML = `
      <div style="color: #dc2626; background: #fee2e2; padding: 0.75rem; border-radius: 6px; border-left: 4px solid #dc2626;">
        <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
        Error connecting to AI service. Please check your internet connection and try again.
      </div>
    `;
  });
}

// Helper Functions
function getUrgencyColor(urgency) {
  const colors = {
    'Low': '#d1fae5; color: #059669',
    'Medium': '#fef9c3; color: #ca8a04',
    'High': '#fee2e2; color: #dc2626', 
    'Urgent': '#f87171; color: #fff'
  };
  return colors[urgency] || '#e5e7eb; color: #6b7280';
}

function applyCategorization(category, urgency) {
  // Find the category in the select dropdown
  const categorySelect = document.querySelector('select[name="category"]');
  const urgencySelect = document.querySelector('select[name="urgency"]');
  
  // Set category
  for (let option of categorySelect.options) {
    if (option.text === category || option.value === category) {
      categorySelect.value = option.value;
      break;
    }
  }
  
  // Set urgency
  urgencySelect.value = urgency;
  
  // Visual feedback
  categorySelect.style.background = '#dcfce7';
  urgencySelect.style.background = '#dcfce7';
  
  setTimeout(() => {
    categorySelect.style.background = '';
    urgencySelect.style.background = '';
  }, 2000);
  
  // Show success message
  const contentDiv = document.getElementById('categorization-content');
  const successMsg = document.createElement('div');
  successMsg.style.cssText = 'color: #059669; font-weight: 600; margin-top: 0.5rem; padding: 0.5rem; background: #dcfce7; border-radius: 4px;';
  successMsg.textContent = 'AI suggestions applied! Don\'t forget to save the ticket.';
  contentDiv.appendChild(successMsg);
  
  setTimeout(() => {
    if (successMsg.parentNode) {
      successMsg.remove();
    }
  }, 3000);
}

function showTemplateSelection() {
  const selectionDiv = document.getElementById('template-selection');
  const selector = document.getElementById('template-selector');
  
  // Show the selection div
  selectionDiv.style.display = 'block';
  
  // Clear current options except the first one
  selector.innerHTML = '<option value="">Choose a template...</option>';
  
  // Fetch templates from database
  fetch('/api/templates/list')
    .then(response => response.json())
    .then(data => {
      if (data.success && data.templates) {
        // Populate dropdown with database templates
        data.templates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.name;
          option.textContent = template.name;
          option.setAttribute('data-use-case', template.use_case_description || '');
          selector.appendChild(option);
        });
      } else {
        console.error('Failed to load templates:', data.error);
        // Show error message instead of fallback options
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Error loading templates - please contact administrator';
        option.disabled = true;
        selector.appendChild(option);
      }
    })
    .catch(error => {
      console.error('Error fetching templates:', error);
      // Show error message instead of fallback options
      const option = document.createElement('option');
      option.value = '';
      option.textContent = 'Connection error - please refresh and try again';
      option.disabled = true;
      selector.appendChild(option);
    });
}

function copyTemplate(subject, body) {
  const text = `Subject: ${subject}\n\n${body}`;
  navigator.clipboard.writeText(text).then(() => {
    // Show success message
    const msg = document.createElement('div');
    msg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #059669; color: white; padding: 0.5rem 1rem; border-radius: 6px; z-index: 9999;';
    msg.textContent = 'Template copied to clipboard!';
    document.body.appendChild(msg);
    
    setTimeout(() => {
      if (msg.parentNode) {
        msg.remove();
      }
    }, 2000);
  }).catch(() => {
    alert('Failed to copy to clipboard. Please copy manually.');
  });
}

function useTemplate(templateName) {
  console.log('Using template:', templateName);
  // Try to find reply textarea and populate it
  const replyBox = document.querySelector('textarea[name="reply_body"]');
  if (replyBox) {
    // This would need the actual template content
    alert('Template functionality: Would populate reply box with ' + templateName);
  } else {
    alert('Template functionality will be implemented: ' + templateName);
  }
}

function useSelectedTemplate() {
  const templateName = document.getElementById('template-selector').value;
  if (templateName) {
    // Use the same function as the AI recommendation
    useRecommendedTemplate(templateName);
    
    // Hide the template selection after use
    document.getElementById('template-selection').style.display = 'none';
  } else {
    alert('Please select a template first.');
  }
}

function useRecommendedTemplate(templateName) {
  // Check if this is VPN Account Creation template
  if (templateName === 'VPN Account Creation') {
    executeVPNAutomation();
    return;
  }
  
  // For other templates, use the original copy-to-clipboard functionality
  fetch('/api/templates/get/' + encodeURIComponent(templateName))
    .then(response => response.json())
    .then(data => {
      if (data.success && data.template) {
        copyTemplate(data.template.subject, data.template.body);
      } else {
        alert('Error loading template: ' + (data.error || 'Template not found'));
      }
    })
    .catch(error => {
      console.error('Error loading template:', error);
      alert('Error loading template');
    });
}

function escapeJs(str) {
  return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '');
}

// VPN Automation Functions
function executeVPNAutomation() {
  const senderEmail = "{{ ticket.sender|e }}";
  
  if (!senderEmail) {
    alert('Error: Cannot determine sender email from ticket');
    return;
  }
  
  // Show VPN credentials popup
  showVPNCredentialsPopup(senderEmail);
}

function showVPNCredentialsPopup(senderEmail) {
  // Create overlay
  const overlay = document.createElement('div');
  overlay.id = 'vpn-credentials-overlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
  `;
  
  // Create popup
  const popup = document.createElement('div');
  popup.style.cssText = `
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  `;
  
  popup.innerHTML = `
    <h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.3rem;">
      <i class="fas fa-shield-alt" style="color: #059669; margin-right: 0.5rem;"></i>
      VPN Account Creation
    </h3>
    
    <div style="margin-bottom: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #059669;">
      <p style="margin: 0; color: #374151; font-size: 0.9rem;">
        <strong>Sender:</strong> ${senderEmail}<br>
        Please review and confirm the VPN credentials below:
      </p>
    </div>
    
    <div style="margin-bottom: 1rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
        VPN Username:
      </label>
      <input type="text" id="vpn-username-input" style="width: 94%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 6px; font-size: 1rem;" placeholder="Loading...">
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
        VPN Password:
      </label>
      <div style="position: relative;">
        <input type="password" id="vpn-password-input" style="width: 87%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 6px; font-size: 1rem; padding-right: 3rem;" placeholder="Loading...">
        <button type="button" onclick="togglePasswordVisibility()" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #6b7280; cursor: pointer; font-size: 1.1rem;">
          <i class="fas fa-eye" id="password-toggle-icon"></i>
        </button>
      </div>
    </div>
    
    <div id="vpn-status-message" style="margin-bottom: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; display: none;">
      <div style="color: #6b7280; font-size: 0.9rem;">Getting suggested credentials...</div>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button onclick="closeVPNPopup()" style="padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
        Cancel
      </button>
      <button onclick="confirmVPNCredentials()" id="vpn-confirm-btn" style="padding: 0.75rem 1.5rem; background: #059669; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" disabled>
        <i class="fas fa-check" style="margin-right: 0.5rem;"></i>Confirm & Execute
      </button>
    </div>
  `;
  
  overlay.appendChild(popup);
  document.body.appendChild(overlay);
  
  // Load suggested credentials
  loadSuggestedCredentials(senderEmail);
}

function loadSuggestedCredentials(senderEmail) {
  const statusDiv = document.getElementById('vpn-status-message');
  statusDiv.style.display = 'block';
  
  fetch('/api/automation/vpn-creation/credentials', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      sender_email: senderEmail
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('vpn-username-input').value = data.suggested_username;
      document.getElementById('vpn-password-input').value = data.generated_password;
      document.getElementById('vpn-confirm-btn').disabled = false;
      statusDiv.style.display = 'none';
    } else {
      statusDiv.innerHTML = '<div style="color: #dc2626;">Error loading credentials: ' + data.error + '</div>';
    }
  })
  .catch(error => {
    console.error('Error loading credentials:', error);
    statusDiv.innerHTML = '<div style="color: #dc2626;">Error loading credentials. Please try again.</div>';
  });
}

function togglePasswordVisibility() {
  const passwordInput = document.getElementById('vpn-password-input');
  const toggleIcon = document.getElementById('password-toggle-icon');
  
  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIcon.className = 'fas fa-eye-slash';
  } else {
    passwordInput.type = 'password';
    toggleIcon.className = 'fas fa-eye';
  }
}

function confirmVPNCredentials() {
  const vpnUsername = document.getElementById('vpn-username-input').value.trim();
  const vpnPassword = document.getElementById('vpn-password-input').value.trim();
  const senderEmail = "{{ ticket.sender|e }}";
  
  if (!vpnUsername || !vpnPassword) {
    alert('Please fill in both username and password');
    return;
  }
  
  // Show confirmation
  if (!confirm(`Confirm VPN Account Creation:\n\nUsername: ${vpnUsername}\nPassword: ${vpnPassword}\n\nThis will start the automated VPN creation process. Continue?`)) {
    return;
  }
  
  // Close popup and show automation progress
  closeVPNPopup();
  showAutomationProgress(senderEmail, vpnUsername, vpnPassword);
}

function closeVPNPopup() {
  const overlay = document.getElementById('vpn-credentials-overlay');
  if (overlay) {
    overlay.remove();
  }
}

function showAutomationProgress(senderEmail, vpnUsername, vpnPassword) {
  // Update the template content area to show progress
  const contentDiv = document.getElementById('template-content');
  
  contentDiv.innerHTML = `
    <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #059669;">
      <h4 style="margin: 0 0 1rem 0; color: #059669; font-size: 1.1rem;">
        <i class="fas fa-cog fa-spin" style="margin-right: 0.5rem;"></i>
        VPN Account Creation in Progress
      </h4>
      
      <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #374151;">
        <strong>Username:</strong> ${vpnUsername}<br>
        <strong>Target User:</strong> ${senderEmail}
      </div>
      
      <div id="automation-progress" style="margin-bottom: 1rem;">
        <div style="background: #e5e7eb; border-radius: 6px; overflow: hidden;">
          <div id="progress-bar" style="background: #059669; height: 8px; width: 0%; transition: width 0.3s ease;"></div>
        </div>
        <div id="progress-text" style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
          Initializing automation...
        </div>
      </div>
      
      <div id="automation-status" style="font-size: 0.9rem; color: #6b7280;">
        Starting VPN account creation process...
      </div>
    </div>
  `;
  
  // Execute the automation
  executeVPNCreationAutomation(senderEmail, vpnUsername, vpnPassword);
}

function executeVPNCreationAutomation(senderEmail, vpnUsername, vpnPassword) {
  fetch('/api/automation/vpn-creation/execute', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      sender_email: senderEmail,
      vpn_username: vpnUsername,
      vpn_password: vpnPassword
    })
  })
  .then(response => response.json())
  .then(data => {
    updateAutomationProgress(data);
  })
  .catch(error => {
    console.error('Automation error:', error);
    showAutomationError('Network error occurred during automation');
  });
}

function updateAutomationProgress(data) {
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const statusDiv = document.getElementById('automation-status');
  
  if (data.success) {
    // Success
    progressBar.style.width = '100%';
    progressText.textContent = 'Automation completed successfully!';
    statusDiv.innerHTML = `
      <div style="color: #059669; font-weight: 600;">
        <i class="fas fa-check-circle" style="margin-right: 0.5rem;"></i>
        VPN Account Creation Complete
      </div>
      <div style="margin-top: 0.5rem; color: #374151;">
        Outlook has been opened with the credentials email drafted.
        Please review and send the email to complete the process.
      </div>
    `;
  } else {
    // Error
    const progressPercentage = (data.steps_completed / data.total_steps) * 100;
    progressBar.style.width = progressPercentage + '%';
    progressText.textContent = `Failed at step ${data.steps_completed}/${data.total_steps}`;
    statusDiv.innerHTML = `
      <div style="color: #dc2626; font-weight: 600;">
        <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
        Automation Failed
      </div>
      <div style="margin-top: 0.5rem; color: #374151;">
        ${data.error_message || 'Unknown error occurred'}
      </div>
      <button onclick="retryAutomation()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
        Retry Automation
      </button>
    `;
  }
}

function showAutomationError(errorMessage) {
  const statusDiv = document.getElementById('automation-status');
  statusDiv.innerHTML = `
    <div style="color: #dc2626; font-weight: 600;">
      <i class="fas fa-exclamation-circle" style="margin-right: 0.5rem;"></i>
      Error
    </div>
    <div style="margin-top: 0.5rem; color: #374151;">
      ${errorMessage}
    </div>
  `;
}

function retryAutomation() {
    // Find the template content div and restore the original AI recommendation
    const templateContent = document.getElementById('template-content');
    if (templateContent) {
        // Restore the exact original AI recommendation HTML structure
        templateContent.innerHTML = `
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-robot" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                        <h4 style="margin: 0; color: #059669;">AI Recommendation</h4>
                    </div>
                    <span style="background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                        95% Confidence
                    </span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #374151;">
                        Recommended Template: <span style="color: #047857;">VPN Account Creation</span>
                    </p>
                    <p style="margin: 0; color: #6b7280; font-size: 0.9rem; line-height: 1.5;">
                        The support ticket specifically requests help with creating a VPN account, which directly aligns with the purpose of the 'VPN Account Creation' template. The keywords 'vpn account' in the subject and description indicate a clear need for VPN access, making this template the most appropriate choice. The template provides essential connection details that the user will need after the account is created, fulfilling their request effectively.
                    </p>
                </div>
                
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button onclick="useRecommendedTemplate('VPN Account Creation')" style="background: #059669; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-check" style="margin-right: 0.3rem;"></i>Use This Template
              </button>
              <button onclick="showTemplateSelection()" style="background: #6b7280; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                <i class="fas fa-list" style="margin-right: 0.3rem;"></i>Choose Different
              </button>
              <button onclick="getTemplateRecommendation()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem;">
                <i class="fas fa-refresh" style="margin-right: 0.3rem;"></i>Re-analyze
              </button>
            </div>
        `;
    }
  
  // Reset any automation state
  window.automationInProgress = false;
}
</script>
