{% extends "base.html" %}

{% block title %}Create Action Step - {{ template.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-plus"></i> Create Action Step</h4>
                    <p class="mb-0 text-muted">Add a workflow step for template: <strong>{{ template.name }}</strong></p>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="form-group">
                            <label for="step_title">Step Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="step_title" name="step_title" required
                                   placeholder="e.g., Create VPN Account, Send Login Credentials, Verify Access">
                        </div>

                        <div class="form-group">
                            <label for="step_type">Step Type <span class="text-danger">*</span></label>
                            <select class="form-control" id="step_type" name="step_type" required>
                                <option value="">Select step type...</option>
                                <option value="manual">Manual - Requires human action</option>
                                <option value="automated">Automated - Can be done by system</option>
                                <option value="verification">Verification - Check or confirm something</option>
                                <option value="communication">Communication - Send email/notification</option>
                                <option value="documentation">Documentation - Record or log information</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="step_description">Step Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="step_description" name="step_description" rows="4" required
                                      placeholder="Detailed description of what needs to be done in this step..."></textarea>
                            <small class="form-text text-muted">
                                <strong>Available Variables:</strong> {user_email}, {username}, {ticket_id}, {subject}, {category}
                                <br>Be specific about the actions required and any tools or systems to use.
                            </small>
                        </div>

                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_automated" name="is_automated">
                                <label class="form-check-label" for="is_automated">
                                    This step can be automated
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Check this if the step could potentially be automated in the future
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="step_config">Step Configuration (JSON) - Optional</label>
                            <textarea class="form-control" id="step_config" name="step_config" rows="3"
                                      placeholder='{"url": "203.125.240.11/login", "timeout": 300, "requires_verification": true}'></textarea>
                            <small class="form-text text-muted">
                                JSON configuration for automated steps (URLs, timeouts, parameters, etc.)
                            </small>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Create Action Step
                            </button>
                            <a href="{{ url_for('main.manage_template_action_steps', template_id=template.id) }}" 
                               class="btn btn-secondary ml-2">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Template Context Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-info-circle"></i> Template Context</h6>
                </div>
                <div class="card-body">
                    <p><strong>Template:</strong> {{ template.name }}</p>
                    <p><strong>Use Case:</strong> {{ template.use_case_description or 'No description provided' }}</p>
                    <p><strong>Email Subject:</strong> {{ template.subject }}</p>
                </div>
            </div>

            <!-- Sample Action Steps Card -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6><i class="fas fa-lightbulb"></i> Sample Action Steps</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>VPN Account Creation Steps:</h6>
                            <div class="small text-muted mb-3">
                                <div class="mb-2">
                                    <strong>1. Navigate to VPN Portal</strong><br>
                                    Go to 203.125.240.11/login and access the admin panel
                                </div>
                                <div class="mb-2">
                                    <strong>2. Create User Account</strong><br>
                                    Create new user with email {user_email} as username
                                </div>
                                <div class="mb-2">
                                    <strong>3. Generate Password</strong><br>
                                    Generate secure 12-character password and save credentials
                                </div>
                                <div class="mb-2">
                                    <strong>4. Send Credentials</strong><br>
                                    Email credentials to user with setup instructions
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Password Reset Steps:</h6>
                            <div class="small text-muted mb-3">
                                <div class="mb-2">
                                    <strong>1. Verify Identity</strong><br>
                                    Confirm user identity through security questions
                                </div>
                                <div class="mb-2">
                                    <strong>2. Reset Password</strong><br>
                                    Generate temporary password in system
                                </div>
                                <div class="mb-2">
                                    <strong>3. Send Instructions</strong><br>
                                    Email temporary password and reset instructions
                                </div>
                                <div class="mb-2">
                                    <strong>4. Follow Up</strong><br>
                                    Check that user successfully changed password
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadSampleStep('vpn_navigate')">
                        Load VPN Navigation Step
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary ml-2" onclick="loadSampleStep('vpn_create')">
                        Load VPN Account Creation
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary ml-2" onclick="loadSampleStep('password_reset')">
                        Load Password Reset
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function loadSampleStep(type) {
    switch(type) {
        case 'vpn_navigate':
            document.getElementById('step_title').value = 'Navigate to VPN Management Portal';
            document.getElementById('step_type').value = 'manual';
            document.getElementById('step_description').value = 'Navigate to 203.125.240.11/login and log in to the VPN management portal using admin credentials. Ensure you have the necessary permissions to create new user accounts.';
            document.getElementById('step_config').value = '{"url": "203.125.240.11/login", "requires_admin": true, "timeout": 300}';
            break;
            
        case 'vpn_create':
            document.getElementById('step_title').value = 'Create VPN User Account';
            document.getElementById('step_type').value = 'manual';
            document.getElementById('step_description').value = 'Create a new VPN user account:\n1. Use {user_email} as the username\n2. Generate a secure 12-character password\n3. Set appropriate access permissions\n4. Save the account credentials securely\n5. Note the account details for the response email';
            document.getElementById('step_config').value = '{"username_format": "{user_email}", "password_length": 12, "access_level": "standard"}';
            break;
            
        case 'password_reset':
            document.getElementById('step_title').value = 'Reset User Password';
            document.getElementById('step_type').value = 'verification';
            document.getElementById('step_description').value = 'Reset the password for user {username}:\n1. Verify the user\'s identity through security questions or alternate email\n2. Generate a temporary password (8-12 characters)\n3. Set password expiration to 24 hours\n4. Log the password reset action in the audit system';
            document.getElementById('step_config').value = '{"verification_required": true, "temp_password_length": 10, "expiration_hours": 24}';
            break;
    }
}

// Validate JSON on input
document.getElementById('step_config').addEventListener('input', function() {
    const value = this.value.trim();
    if (value && value !== '') {
        try {
            JSON.parse(value);
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } catch (e) {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    } else {
        this.classList.remove('is-valid', 'is-invalid');
    }
});

// Auto-resize textarea
document.getElementById('step_description').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});
</script>
{% endblock %}
